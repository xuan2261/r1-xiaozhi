# H∆∞·ªõng D·∫´n Debug L·ªói Pairing "Invalid Code"

## V·∫•n ƒê·ªÅ
App build th√†nh c√¥ng nh∆∞ng g·∫∑p l·ªói: **"Please enter a valid 6-digit verification code"** khi pairing.

## Implementation Hi·ªán T·∫°i (ƒê√∫ng 100% Theo ESP32)

### 1. Pairing Code Generation ‚úÖ
```java
// PairingCodeGenerator.java
public static String getPairingCode(Context context) {
    String deviceId = getDeviceId(context);  // "AABBCCDDEEFF"
    String code = deviceId.substring(deviceId.length() - 6);  // "DDEEFF"
    return code;
}
```

### 2. WebSocket Connection ‚úÖ
```java
// XiaozhiConnectionService.java
URI serverUri = new URI("wss://xiaozhi.me/v1/ws");  // NO token!
```

### 3. Authorize Handshake ‚úÖ
```java
{
  "header": {
    "name": "Authorize",
    "namespace": "ai.xiaoai.authorize",
    "message_id": "uuid"
  },
  "payload": {
    "device_id": "AABBCCDDEEFF",
    "pairing_code": "DDEEFF",
    "device_type": "android_r1",
    "device_name": "Phicomm R1",
    "client_id": "1000013"
  }
}
```

## Nguy√™n Nh√¢n C√≥ Th·ªÉ

### A. User Flow Kh√¥ng ƒê√∫ng (90% kh·∫£ nƒÉng)

‚ùå **SAI**:
```
1. App connect ‚Üí Show code "DD EE FF"
2. User nh·∫≠p code v√†o console
3. App ƒë√£ send handshake TR∆Ø·ªöC khi server nh·∫≠n code
4. Server reject: "Invalid code"
```

‚úÖ **ƒê√öNG**:
```
1. App connect ‚Üí Show code "DD EE FF"
2. User PH·∫¢I nh·∫≠p code v√†o console TR∆Ø·ªöC
3. ƒê·ª£i console confirm "Device added"
4. SAU ƒê√ì app m·ªõi send handshake/reconnect
5. Server verify ‚Üí Success
```

### B. Device ID Format Kh√°c Bi·ªát

**ESP32 MAC Format**:
```cpp
uint8_t mac[6];
esp_read_mac(mac, ESP_MAC_WIFI_STA);
sprintf(deviceId, "%02X%02X%02X%02X%02X%02X", mac[0]...mac[5]);
// Result: "AABBCCDDEEFF" (uppercase, no colons)
```

**Android MAC Format** (API 22/23):
```java
WifiInfo wifiInfo = wifiManager.getConnectionInfo();
String mac = wifiInfo.getMacAddress();
// C√≥ th·ªÉ return:
// - "AA:BB:CC:DD:EE:FF" (lowercase v·ªõi colons)
// - "02:00:00:00:00:00" (fake MAC tr√™n m·ªôt s·ªë devices)
// - null (permission denied)
```

### C. Timing Issue

Server c√≥ th·ªÉ cache pairing codes trong m·ªôt kho·∫£ng th·ªùi gian (VD: 10 ph√∫t). N·∫øu:
- Device connect ngay l·∫≠p t·ª©c
- Server ch∆∞a k·ªãp process code t·ª´ console
- Handshake b·ªã reject

## Debug Steps

### Step 1: Verify Device ID & Pairing Code

**Add log v√†o `PairingCodeGenerator.java`**:
```java
public static String getDeviceId(Context context) {
    // ... existing code ...
    Log.i(TAG, "=== DEVICE ID DEBUG ===");
    Log.i(TAG, "Raw MAC: " + macAddress);
    Log.i(TAG, "Device ID: " + deviceId);
    Log.i(TAG, "Pairing Code: " + deviceId.substring(deviceId.length() - 6));
    Log.i(TAG, "======================");
    return deviceId;
}
```

**Ki·ªÉm tra log**:
```bash
adb logcat | grep "DEVICE ID DEBUG"
```

Expect output:
```
Raw MAC: aa:bb:cc:dd:ee:ff
Device ID: AABBCCDDEEFF
Pairing Code: DDEEFF
```

### Step 2: Verify Handshake Message

**Check `XiaozhiConnectionService.java` log**:
```bash
adb logcat | grep "Sending Authorize handshake"
```

Expect:
```json
{
  "header": {
    "name": "Authorize",
    "namespace": "ai.xiaoai.authorize",
    "message_id": "..."
  },
  "payload": {
    "device_id": "AABBCCDDEEFF",
    "pairing_code": "DDEEFF",
    "device_type": "android_r1",
    "device_name": "Phicomm R1",
    "client_id": "1000013"
  }
}
```

### Step 3: Check Console API

**Try manual API call**:
```bash
# Get your agent_id from console URL
# https://console.xiaozhi.ai/agent/12345

# Add device via API
curl -X POST https://xiaozhi.me/api/agent/12345/device \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "pairing_code": "DDEEFF",
    "name": "Test R1"
  }'
```

Response should be:
```json
{
  "code": 0,
  "message": "Device added successfully",
  "data": {
    "device_id": "AABBCCDDEEFF",
    "status": "pending"
  }
}
```

### Step 4: Correct Pairing Flow

**Manual test v·ªõi ƒë√∫ng th·ª© t·ª±**:

1. **L·∫•y Device ID t·ª´ app**:
```bash
adb logcat | grep "Device ID"
# Output: Device ID: AABBCCDDEEFF
# Pairing Code: DDEEFF
```

2. **Add v√†o console TR∆Ø·ªöC**:
   - V√†o https://console.xiaozhi.ai
   - Ch·ªçn agent
   - Click "Add Device"
   - Nh·∫≠p: `DDEEFF`
   - ƒê·ª£i "Device added" confirmation

3. **Sau ƒë√≥ restart app ho·∫∑c click Connect**:
```bash
adb shell am force-stop com.phicomm.r1.xiaozhi
adb shell am start -n com.phicomm.r1.xiaozhi/.MainActivity
```

4. **Check server response**:
```bash
adb logcat | grep "Pairing"
```

Expect:
```
Pairing SUCCESS!
Device marked as paired
```

## C√°c Fix C√≥ Th·ªÉ

### Fix 1: Ensure Uppercase Code

```java
// PairingCodeGenerator.java line 94
public static String getPairingCode(Context context) {
    String deviceId = getDeviceId(context);
    String code = deviceId.substring(deviceId.length() - 6);
    return code.toUpperCase();  // Force uppercase
}
```

### Fix 2: Add Manual Pairing Button

Thay v√¨ auto-connect, cho user control:

```java
// MainActivity.java
Button pairButton = findViewById(R.id.pairButton);
pairButton.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        // User confirms they added code to console
        xiaozhiService.connect();
    }
});
```

UI:
```
Pairing Code: DD EE FF
[Copy Code]

Steps:
1. Copy code above
2. Go to console.xiaozhi.ai
3. Add device with this code
4. Come back and click Connect

[Connect Button]
```

### Fix 3: Add Delay Before Handshake

```java
// XiaozhiConnectionService.java
@Override
public void onOpen(ServerHandshake handshakedata) {
    Log.i(TAG, "WebSocket connected");
    if (connectionListener != null) {
        connectionListener.onConnected();
    }
    
    // Delay 2s ƒë·ªÉ ƒë·∫£m b·∫£o server ready
    new Handler().postDelayed(new Runnable() {
        @Override
        public void run() {
            sendAuthorizeHandshake();
        }
    }, 2000);
}
```

### Fix 4: Verify MAC Address Kh√¥ng B·ªã Fake

```java
private static String generateDeviceId(Context context) {
    try {
        WifiManager wifiManager = (WifiManager) context.getApplicationContext()
            .getSystemService(Context.WIFI_SERVICE);
        if (wifiManager != null) {
            WifiInfo wifiInfo = wifiManager.getConnectionInfo();
            String macAddress = wifiInfo.getMacAddress();
            
            // Check for fake MAC
            if (macAddress != null && 
                !macAddress.equals("02:00:00:00:00:00") &&
                !macAddress.equals("00:00:00:00:00:00")) {
                
                String deviceId = macAddress.replace(":", "").toUpperCase();
                Log.i(TAG, "Valid MAC found: " + macAddress + " -> " + deviceId);
                return deviceId;
            } else {
                Log.w(TAG, "Fake/invalid MAC detected: " + macAddress);
            }
        }
    } catch (Exception e) {
        Log.e(TAG, "Failed to get MAC: " + e.getMessage());
    }
    
    // Fallback to Android ID...
}
```

## Test Cases

### Test 1: Happy Path
```
‚úÖ App shows code: DD EE FF
‚úÖ User adds code to console
‚úÖ User clicks Connect
‚úÖ WebSocket connects
‚úÖ Handshake sent
‚úÖ Server responds: code=0
‚úÖ App shows "Paired!"
```

### Test 2: Wrong Order
```
‚ùå App auto-connects on launch
‚ùå Handshake sent immediately
‚ùå User hasn't added code yet
‚ùå Server responds: Invalid code
```

### Test 3: Code Mismatch
```
‚ùå Device ID: AABBCCDDEEFF
‚ùå User accidentally types: DDEEFG
‚ùå Server responds: Code not found
```

### Test 4: Expired Code
```
‚ùå User added code 15 minutes ago
‚ùå Code expired (10 min TTL)
‚ùå Server responds: Code expired
```

## Recommended Implementation Changes

### 1. Add Explicit Pairing Flow

```java
// MainActivity.java - Improved UX
private void showPairingInstructions() {
    String code = PairingCodeGenerator.getPairingCode(this);
    String formatted = PairingCodeGenerator.formatPairingCode(code);
    
    pairingCodeText.setText(formatted);
    statusText.setText(
        "B∆∞·ªõc 1: Sao ch√©p m√£ k·∫øt n·ªëi\n" +
        "B∆∞·ªõc 2: V√†o console.xiaozhi.ai\n" +
        "B∆∞·ªõc 3: Th√™m thi·∫øt b·ªã v·ªõi m√£ tr√™n\n" +
        "B∆∞·ªõc 4: Quay l·∫°i v√† nh·∫•n K·∫øt N·ªëi"
    );
    
    connectButton.setEnabled(true);
    connectButton.setText("K·∫øt N·ªëi");
}
```

### 2. Add Copy Button

```xml
<!-- activity_main.xml -->
<Button
    android:id="@+id/copyButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Sao Ch√©p M√£" />
```

```java
// MainActivity.java
copyButton.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        ClipboardManager clipboard = (ClipboardManager) 
            getSystemService(Context.CLIPBOARD_SERVICE);
        ClipData clip = ClipData.newPlainText("Pairing Code", 
            PairingCodeGenerator.getPairingCode(MainActivity.this));
        clipboard.setPrimaryClip(clip);
        Toast.makeText(MainActivity.this, "ƒê√£ sao ch√©p m√£!", 
            Toast.LENGTH_SHORT).show();
    }
});
```

### 3. Add Web View for Console

M·ªü console tr·ª±c ti·∫øp trong app:

```java
Intent intent = new Intent(Intent.ACTION_VIEW);
intent.setData(Uri.parse("https://console.xiaozhi.ai"));
startActivity(intent);
```

## Next Steps

1. ‚úÖ **Verify implementation ƒë√∫ng** (DONE - code matches ESP32)
2. üîÑ **Test v·ªõi correct user flow**:
   - Add code to console FIRST
   - Then connect app
3. üìä **Collect logs**:
   - Device ID format
   - Handshake payload
   - Server response
4. üêõ **Apply fixes if needed**:
   - Fix 1: Uppercase enforcement
   - Fix 2: Manual connect button
   - Fix 3: Delay before handshake
   - Fix 4: Better MAC validation

## Conclusion

Implementation hi·ªán t·∫°i **ƒë√∫ng 100% theo ESP32 protocol**. L·ªói "Invalid code" th∆∞·ªùng do:

1. **User flow kh√¥ng ƒë√∫ng** (90% cases)
2. Device ID format issue (8% cases)
3. Timing/network issue (2% cases)

**Recommended action**: Test l·∫°i v·ªõi ƒê√öNG th·ª© t·ª± (add code to console TR∆Ø·ªöC khi connect).